---
layout: post
title: 修复Android终端输入中文无法完全删除问题过程记录
author: SmaliYuu
tags: 技术
excerpt_separator: <!--more-->
---

这两天在一个用户反馈的问题，他说运行结果里输入了中文就没法完全清除了。我这边试了试，发现确实可以复现，准备修复下。

<!--more-->

## 各种不同的表现

**Termux的shell程序**  
刚进入Termux，输入中文按手机输入法上的退格按钮，每个字都可以删除完，这是最正常的表现。

**Termux的hello_scanf程序**  
在Termux里安装了gcc然后编译一个最简单的scanf程序，发现运行起来同样不能删除每个汉字，表现和用户反馈现象一致。

**Mac终端上的hello_scanf程序**  
离谱的是，就连Mac上的终端编译运行同样的scanf程序，一样有问题，不能删除每个汉字。


## 代码流程分析
从用户按下手机输入法退格开始：
1. View的onKeyDown函数回调，收到按下的KeyCode发送给TerminalView.handleKeyCode
2. 收到KEYCODE_DEL后，将其转化为Linux Console/VT220字符：ASCII DEL 0x7F(十进制为127) 
3. 将0x7F写入mTerminalToProcessIOQueue，从而写入终端子进程文件描述符mTerminalFileDescriptor
4. 程序会从描述符里返回回来终端要处理的指令符号

接上面第4步，Termux的shell程序返回回来的结果是[8,8,27,91,75]；Termux的hello_scanf程序返回回来的是[8,32,8]。很明显前者知道我们输入的是宽字符，需要退格两次，后者没做处理，只退格了一次。  
注：27，91，75对应的是ESC\[K，该指令意思是光标不动，清除光标右侧的内容；32,8意思是当前位置写入一个空格然后再退格一次，再详细点[8,32,8]会先向左退一格(8)，然后写下空格向右进一格(32)，最后再向左退一格(8)，实际上是用空格覆盖了要删除的内容。

## 处理方式
目前来看，标准的终端（包括Termux，包括mac的zsh）都没对宽字符直接进行处理，他们本意是让可执行程序开发者自己处理宽字符问题，类似于Termux的shell程序。但我的目标用户都不是精通字符处理的高手，更不会想适配终端程序的问题，因此我们直接修改终端，在终端这边处理这个问题。**值得注意的是，一旦我们判断要删除的字符是宽字符就主动退格两列的宽度，那么Termux的shell程序就会在我们这种不标准的终端上出问题，因为hello_scanf收到一个退格指令(8)会退两列，而shell会发送两次退格指令(8)会退四列。**

## 具体实现
processCodePoint会对收到的退格指令进行处理，case 8就是我们要关注的分支。我们看到这里写死了收到退格就向左退一列。
```
setCursorCol(mCursorCol - 1);
```
我们仅需要判断光标前是不是宽字符即可，如果是就-2；如果不是就-1